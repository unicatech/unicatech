{% load static %}
<!DOCTYPE html>

<!-- Header -->
{% include 'head.html' %}
<!-- /header -->
<!-- Sidebar -->
{% include 'sidebar.html' %}
<!-- /Sidebar -->
<div class="page-wrapper">
  <div class="content">
    <div class="row">
      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash2.svg' %}" alt="img"></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>R${{valor_total_venda | floatformat:2}}</h5>
            <h6>Faturamento Total no Período</h6>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash1">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash1.svg' %}" alt="img"></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>R${{valor_recebido_venda | floatformat:2}}</h5>
            <h6>Valor Recebido no Período</h6>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash2">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash3.svg' %}" alt="img"></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>R${{total_a_receber | floatformat:2}}</h5>
            <h6>Total a Receber no Período</h6>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash2">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash3.svg' %}" alt="img"></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>R${{valor_excedente_venda | floatformat:2}}</h5>
            <h6>Valor Excedente das Vendas no Período</h6>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash3">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash4.svg' %}" alt="img"></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>R${{valor_total_estoque | floatformat:2}}</h5>
            <h6>Valor Total do Estoque</h6>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash3">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash4.svg' %}" alt="img"></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>R${{ticket_medio | floatformat:2}}</h5>
            <h6>Ticket Médio das Vendas no Período</h6>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash3">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash4.svg' %}" alt="img"></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>R${{ticket_medio | floatformat:2}}</h5>
            <h6>Para preencher</h6>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-sm-6 col-12">
        <div class="dash-widget dash3">
          <div class="dash-widgetimg">
            <span><img src="{% static 'img/icons/dash4.svg' %}" alt="img"></span>
          </div>
          <div class="dash-widgetcontent">
            <h5>R${{ticket_medio | floatformat:2}}</h5>
            <h6>Para preencher</h6>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-sm-6 col-12 d-flex">
        <div class="dash-count">
          <div class="dash-counts">
            <h4>R${{venda_lucro_total | floatformat:2}}</h4>
            <h5>Lucro Total no Período</h5>
          </div>
          <div class="dash-imgs">
            <i data-feather="user"></i>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12 d-flex">
        <div class="dash-count">
          <div class="dash-counts">
            <h4>R${{consolidado_compras | floatformat:2}}</h4>
            <h5>Total em Compras no Período</h5>
          </div>
          <div class="dash-imgs">
            <i data-feather="user-check"></i>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12 d-flex">
        <div class="dash-count das2">
          <div class="dash-counts">
            <h4>R${{valor_despesa_total | floatformat:2}}</h4>
            <h5>Despesas Totais no Período</h5>
          </div>
          <div class="dash-imgs">
            <i data-feather="file-text"></i>
          </div>
        </div>
      </div>
      <div class="col-lg-3 col-sm-6 col-12 d-flex">
        <div class="dash-count das3">
          <div class="dash-counts">
            <h4>R${{saldo_liquido_mensal | floatformat:2}}</h4>
            <h5>Saldo Líquido Mensal</h5>
          </div>
          <div class="dash-imgs">
            <i data-feather="file"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- PERÍODO DO FATURAMENTO (MÊS/ANO) -->
    <div class="row">
      <div class="col-lg-5 col-sm-12 col-12 d-flex">
        <div class="card flex-fill">
          <h4 class="card-title mb-0">Período do Faturamento</h4>
          <div class="d-flex align-items-center gap-2 mt-3">
            <select id="mesAnoSelect" class="form-select w-auto" onchange="muda_data_select();">
              <!-- opções geradas via JS -->
            </select>
            <div class="addonset">
              <img src="{% static 'img/icons/calendars.svg' %}" alt="img">
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Mantém o envio como 'date' sem mexer no views -->
    <input type="hidden" id="dt" value="">

    <div class="row">
      <div class="col-lg-5 col-sm-12 col-12 d-flex">
        <div class="card flex-fill">
          <div class="card-header pb-0 d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Lucro Líquido por Venda</h4>
            <div class="dropdown">
              <a href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false" class="dropset">
                <i class="fa fa-ellipsis-v"></i>
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a href="/listarvendas/" class="dropdown-item">Listar Vendas</a></li>
                <li><a href="/fazervendas/" class="dropdown-item">Fazer Vendas</a></li>
              </ul>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive dataview">
              <table class="table datatable ">
                <thead>
                  <tr>
                    <th>Nota</th>
                    <th>Cliente</th>
                    <th>Lucro</th>
                    <th>Data</th>
                  </tr>
                </thead>
                <tbody>
                  {% for venda in vendas %}
                  <tr>
                    <td>{{venda.venda_id}}</td>
                    <td class="productimgname">{{venda.nome_cliente}}</td>
                    <td>R${{venda.lucro_venda | floatformat:2}}</td>
                    <td>{{venda.data_venda}}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-5 col-sm-12 col-12 d-flex">
        <div class="card flex-fill">
          <div class="card-header pb-0 d-flex justify-content-between align-items-center">
            <h4 class="card-title mb-0">Despesas</h4>
            <div class="dropdown">
              <a href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false" class="dropset">
                <i class="fa fa-ellipsis-v"></i>
              </a>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                <li><a href="/adicionardespesa/" class="dropdown-item">Adicionar Despesa</a></li>
                <li><a href="/categoriadespesa" class="dropdown-item">Cadastrar Categoria de Despesa</a></li>
              </ul>
            </div>
          </div>
          <div class="card-body">
            <div class="table-responsive dataview">
              <table class="table datatable ">
                <thead>
                  <tr>
                    <th>Data</th>
                    <th>Despesa</th>
                    <th>Valor</th>
                    <th>Conta Débito</th>
                  </tr>
                </thead>
                <tbody>
                  {% for despesa in despesas %}
                  <tr>
                    <td>{{despesa.data}}</td>
                    <td>{{despesa.nome_despesa}}</td>
                    <td>{{despesa.moeda}}{{despesa.valor | floatformat:2}}</td>
                    <td>{{despesa.conta}}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- COMPRAS (em Real) -->
      <div class="row">
        <div class="col-lg-5 col-sm-12 col-12 d-flex">
          <div class="card flex-fill">
            <div class="card-header pb-0 d-flex justify-content-between align-items-center">
              <h4 class="card-title mb-0">Compras (em Real)</h4>
              <div class="dropdown">
                <a href="javascript:void(0);" data-bs-toggle="dropdown" aria-expanded="false" class="dropset">
                  <i class="fa fa-ellipsis-v"></i>
                </a>
                <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                  <li><a href="/fazercompras/" class="dropdown-item">Fazer Compra</a></li>
                  <li><a href="/listarcompras/" class="dropdown-item">Listar Compras</a></li>
                </ul>
              </div>
            </div>
            <div class="card-body">
              <div class="table-responsive dataview">
                <table class="table datatable ">
                  <thead>
                    <tr>
                      <th>Nota</th>
                      <th>Fornecedor</th>
                      <th>Valor</th>
                      <th>Data</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for compra in compras %}
                    <tr>
                      <td>{{compra.compra_id}}</td>
                      <td class="productimgname">{{compra.nome_fornecedor}}</td>
                      <td>R${{compra.valor_total_compra | floatformat:2}}</td>
                      <td>{{compra.data_compra}}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- PURCHASE & SALES (gráfico) -->
        <div class="col-lg-7 col-sm-12 col-12 d-flex">
          <div class="card flex-fill">
            <div class="card-header pb-0 d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">Purchase & Sales</h5>
              <div class="graph-sets">
                <ul>
                  <li><span>Sales</span></li>
                  <li><span>Purchase</span></li>
                </ul>
                <div class="dropdown">
                  <button class="btn btn-white btn-sm dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown" aria-expanded="false">
                    2022 <img src="{% static 'img/icons/dropdown.svg' %}" alt="img" class="ms-2">
                  </button>
                  <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                    <li><a href="javascript:void(0);" class="dropdown-item">2022</a></li>
                    <li><a href="javascript:void(0);" class="dropdown-item">2021</a></li>
                    <li><a href="javascript:void(0);" class="dropdown-item">2020</a></li>
                  </ul>
                </div>
              </div>
            </div>
            <div class="card-body">
              <div id="sales_charts"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TABELA DEMO (Expired Products) -->
      <div class="card mb-0">
        <div class="card-body">
          <h4 class="card-title">Expired Products</h4>
          <div class="table-responsive dataview">
            <table class="table datatable ">
              <thead>
                <tr>
                  <th>SNo</th>
                  <th>Product Code</th>
                  <th>Product Name</th>
                  <th>Brand Name</th>
                  <th>Category Name</th>
                  <th>Expiry Date</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>1</td>
                  <td><a href="javascript:void(0);">IT0001</a></td>
                  <td class="productimgname">
                    <a class="product-img" href="productlist.html">
                      <img src="{% static 'img/product/product2.jpg' %}" alt="product">
                    </a>
                    <a href="productlist.html">Orange</a>
                  </td>
                  <td>N/D</td>
                  <td>Fruits</td>
                  <td>12-12-2022</td>
                </tr>
                <tr>
                  <td>2</td>
                  <td><a href="javascript:void(0);">IT0002</a></td>
                  <td class="productimgname">
                    <a class="product-img" href="productlist.html">
                      <img src="{% static 'img/product/product3.jpg' %}" alt="product">
                    </a>
                    <a href="productlist.html">Pineapple</a>
                  </td>
                  <td>N/D</td>
                  <td>Fruits</td>
                  <td>25-11-2022</td>
                </tr>
                <tr>
                  <td>3</td>
                  <td><a href="javascript:void(0);">IT0003</a></td>
                  <td class="productimgname">
                    <a class="product-img" href="productlist.html">
                      <img src="{% static 'img/product/product4.jpg' %}" alt="product">
                    </a>
                    <a href="productlist.html">Stawberry</a>
                  </td>
                  <td>N/D</td>
                  <td>Fruits</td>
                  <td>19-11-2022</td>
                </tr>
                <tr>
                  <td>4</td>
                  <td><a href="javascript:void(0);">IT0004</a></td>
                  <td class="productimgname">
                    <a class="product-img" href="productlist.html">
                      <img src="{% static 'img/product/product5.jpg' %}" alt="product">
                    </a>
                    <a href="productlist.html">Avocat</a>
                  </td>
                  <td>N/D</td>
                  <td>Fruits</td>
                  <td>20-11-2022</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div><!-- /content -->
  </div><!-- /page-wrapper -->
</div>

{% include 'footer.html' %}

<script>
/** ======================
 *  SELECT MÊS-ANO (persiste após reload)
 *  Mantém envio como 'date' (YYYY-MM-DD) via querystring
 *  ====================== */

// Meses PT-BR
const monthNames = [
  "Janeiro","Fevereiro","Março","Abril","Maio","Junho",
  "Julho","Agosto","Setembro","Outubro","Novembro","Dezembro"
];

// Helper para pegar querystring
function getParam(name) {
  const params = new URLSearchParams(window.location.search);
  return params.get(name);
}

function gerarMeses() {
  const select = document.getElementById("mesAnoSelect");
  const hoje = new Date();

  // Lê seleção atual da URL (se houver). Se não houver, usa mês atual.
  let anoSel = getParam("ano_selecionado") || String(hoje.getFullYear());
  let mesSel = getParam("mes_selecionado") || String(hoje.getMonth()+1).padStart(2,'0');
  let diaSel = getParam("dia_selecionado") || "01";

  // Gera meses do mês atual voltando até 1900 (na prática, "sem limite" razoável)
  let ano = hoje.getFullYear();
  let mes = hoje.getMonth(); // 0..11

  while (ano >= 1900) {
    const value = `${ano}-${String(mes+1).padStart(2,'0')}-01`;
    const label = `${monthNames[mes]}-${ano}`;
    const option = new Option(label, value);
    select.appendChild(option);

    mes--;
    if (mes < 0) { mes = 11; ano--; }
  }

  // Se o mês/ano selecionado não existir na lista (ex.: anterior a 1900), insere no topo
  const selectedValue = `${anoSel}-${mesSel}-01`;
  const hasOption = Array.from(select.options).some(o => o.value === selectedValue);
  if (!hasOption) {
    const customLabel = `${monthNames[parseInt(mesSel,10)-1]}-${anoSel}`;
    select.insertBefore(new Option(customLabel, selectedValue, true, true), select.firstChild);
  }
  // Seleciona o mês/ano atual (da URL ou do mês corrente)
  select.value = selectedValue;

  // Atualiza o hidden 'dt' (mantém o formato date)
  document.getElementById("dt").value = `${anoSel}-${mesSel}-${diaSel}`;
}

function muda_data_select() {
  const valor = document.getElementById("mesAnoSelect").value; // yyyy-mm-01
  document.getElementById("dt").value = valor;
  const [ano, mes, dia] = valor.split("-");
  // Redireciona preservando o protocolo do views.py
  window.location.replace(`/?dia_selecionado=${dia}&mes_selecionado=${mes}&ano_selecionado=${ano}`);
}

document.addEventListener("DOMContentLoaded", gerarMeses);
</script>

<!-- Chart JS -->
<script src="{% static 'plugins/apexchart/apexcharts.min.js' %}"></script>
<script src="{% static 'plugins/apexchart/chart-data.js' %}"></script>

</body>
</html>

