{% load static %}
{% load l10n %}
<!DOCTYPE html>
<html>
<head>
  <!-- Header -->
  {% include 'head.html' %}
  <!-- /header -->

  <!-- Sidebar -->
  {% include 'sidebar.html' %}
  <!-- /Sidebar -->

  <style>
    /* Cabe√ßalhos */
    .page-header { margin-bottom: 1.5rem; }
    .page-title h4 { font-size: 1.6rem; font-weight: 600; color: #343a40; }
    .page-title h6 { font-size: 1rem; color: #6c757d; }

    /* Cards */
    .card {
      border-radius: 12px;
      border: 1px solid #e9ecef;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      margin-bottom: 1.5rem;
    }
    .card-body { padding: 1.5rem; }

    /* Labels e inputs */
    .form-group label { font-weight: 500; color: #495057; }
    .form-control, .select {
      border-radius: 6px; border: 1px solid #ced4da;
      padding: 8px 10px; font-size: 0.95rem;
    }

    /* Bot√µes laranja */
    .btn-primary, .btn-submit {
      background-color: #fd7e14 !important;
      border: none; border-radius: 6px; color: #fff;
      padding: 8px 16px; font-size: 0.95rem;
    }
    .btn-primary:hover, .btn-submit:hover { background-color: #e96b0c !important; }

    /* Tabela */
    table.datanew { width: 100%; border-collapse: collapse; }
    table.datanew thead th {
      background: #fff3e6; color: #fd7e14; font-weight: 600;
      padding: 12px; border-bottom: 2px solid #fd7e14;
    }
    table.datanew tbody td { padding: 10px; border-bottom: 1px solid #e9ecef; }

    /* DataTables: mover busca p/ esquerda e estilizar */
    div.dataTables_wrapper div.dataTables_filter {
      float: left !important; /* for√ßa √† esquerda */
      text-align: left !important;
    }
    /* Esconde ‚ÄúSearch:‚Äù original e injeta ‚ÄúBuscar‚Äù */
    div.dataTables_wrapper div.dataTables_filter label {
      font-weight: 500; color: #fd7e14;
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 0; /* esconde texto original do label */
    }
    div.dataTables_wrapper div.dataTables_filter label::before {
      content: "Buscar";
      font-size: 0.95rem; font-weight: 600; color: #fd7e14;
      margin-right: 4px;
    }
    div.dataTables_wrapper div.dataTables_filter input {
      font-size: 0.9rem; margin-left: 0;
      border-radius: 6px; border: 1px solid #fd7e14;
      padding: 6px 10px; color: #495057; outline: none;
    }
    div.dataTables_wrapper div.dataTables_filter input:focus {
      border-color: #e96b0c;
      box-shadow: 0 0 0 0.2rem rgba(253,126,20,0.25);
    }

    /* Alerta */
    .closebtn {
      padding: 10px; border-radius: 6px; margin-top: 10px;
      background-color: #fff4e5; color: #d9480f; font-weight: 500; position: relative;
    }
    .closebtn span { position: absolute; right: 12px; top: 8px; cursor: pointer; font-size: 20px; }

    /* Subt√≠tulo/filtro */
    .filter-header {
      font-weight: 600; color: #343a40; border-left: 4px solid #fd7e14;
      padding-left: 10px; margin-bottom: 1rem;
    }
  </style>
</head>
<body>
<div class="page-wrapper">
  <div class="content">
    <div class="page-header">
      <div class="page-title">
        <h4>Lista de Vendas</h4>
        <h6>Gerencie suas Vendas</h6>
      </div>
        <div class="page-btn">
        <a href="{% url 'fazervendasaparelhos'%}" class="btn btn-primary">
          <img src="{% static 'img/icons/plus.svg' %}" alt="img"> Fazer Nova Venda de Aparelhos
        </a>
        <a href="{% url 'fazervendaspecas'%}" class="btn btn-primary">
          <img src="{% static 'img/icons/plus.svg' %}" alt="img"> Fazer Nova Venda de Pe√ßas
        </a>
      </div>
    </div>

    <!-- üìÖ Filtro por datas -->
    <div class="card mb-3">
      <div class="card-body">
        <div class="filter-header">üìÖ Buscar Venda por Datas</div>
        <form method="post" action="{% url 'listarvendas' %}">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-lg col-sm-6 col-12">
              <div class="form-group">
                <label for="data_inicio">Data de In√≠cio</label>
                <input type="date" id="data_inicio" name="data_inicio" class="form-control">
              </div>
            </div>
            <div class="col-lg col-sm-6 col-12">
              <div class="form-group">
                <label for="data_fim">Data do Fim</label>
                <input type="date" id="data_fim" name="data_fim" class="form-control">
              </div>
            </div>
           <div class="col-lg-4 col-sm-6 col-12">
                <label class="form-label">IMEI</label>
                <input type="text" class="form-control" name="descricao" placeholder="">
           </div>
            <div class="col-lg-2 col-sm-6 col-12 d-flex align-items-end">
              <button type="submit" class="btn btn-primary w-100">Filtrar</button>
            </div>
          </div>
        </form>
      </div>
    </div>

    <!-- üìã Lista de Vendas -->
    <div class="card">
      <div class="card-body">
        <h5 style="font-weight:600;color:#343a40;border-left:4px solid #fd7e14;padding-left:10px;margin-bottom:1rem;">
          üìã Vendas Realizadas
        </h5>
        <div class="table-responsive">
          <table class="table datanew" id="tabela-vendas">
            <thead>
              <tr>
                <th></th>
                <th>Cliente</th>
                <th>Identificador</th>
                <th>Data</th>
                <th>Valor</th>
                <th>A√ß√£o</th>
              </tr>
            </thead>
            <tbody>
              {% for venda in listarVendas %}
              <tr>
                <td></td>
                <td>{{ venda.cliente.nomeCliente }}</td>
                <td>{{ venda.idVenda }}</td>
                <td>{{ venda.dataVenda }}</td>
                <td>{{ venda.moeda }} {{ venda.valorVenda|floatformat:2 }}</td>
                <td>
                  <a class="me-3" href="/fazervendas/?idVenda={{ venda.idVenda }}">
                    <img src="{% static 'img/icons/edit.svg' %}" alt="img">
                  </a>
                  <a class="me-3 confirm-text" href="/listarvendas/?idVenda={{ venda.idVenda }}&funcao=apagar">
                    <img src="{% static 'img/icons/delete.svg' %}" alt="img">
                  </a>
                    <a href="#"  class="me-3 view-sale" data-url="/fazervendas/?idVenda={{ venda.idVenda }}&funcao=modal">
                    <img src="{% static 'img/icons/eye.svg' %}" alt="img">
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
    <!-- /Lista -->
  </div>
</div>
<!-- Modal gen√©rico -->
<div class="modal fade" id="modalVenda" tabindex="-1" aria-labelledby="modalVendaLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-body">
        <div class="text-center p-3">Carregando...</div>
      </div>
    </div>
  </div>
</div>
{% include 'footer.html' %}
<script>
function somarSubtotaisDaModal(modalElement) {
  let total = 0;

  // Soma os subtotais (tratando v√≠rgula/ponto e valores vazios)
  modalElement.querySelectorAll(".subtotal").forEach(td => {
    const txt = (td.textContent || td.innerText || "").trim();
    const num = parseFloat(txt.replace(/\./g, '').replace(',', '.'));
    if (!isNaN(num)) total += num;
  });

  const span = modalElement.querySelector("#totalVenda");
  if (span) {
    span.textContent = total.toFixed(2).replace('.', ',');
  }
}

document.addEventListener("DOMContentLoaded", function () {
  const modalEl = document.getElementById("modalVenda");
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl, {
    backdrop: true,   // permite fechar clicando fora
    keyboard: true    // permite fechar com ESC
  });

  // Quando clicar em "ver venda"
  document.querySelectorAll(".view-sale").forEach(link => {
    link.addEventListener("click", function (e) {
      e.preventDefault();

      const url = this.dataset.url;
      const modalBody = modalEl.querySelector(".modal-body");
      modalBody.innerHTML = '<div class="text-center p-3">Carregando...</div>';

      fetch(url)
        .then(r => r.text())
        .then(html => {
          modalBody.innerHTML = html;
          // recalcula total depois do conte√∫do carregado
          somarSubtotaisDaModal(modalEl);
        })
        .catch(() => {
          modalBody.innerHTML = "<div class='text-danger p-3'>Erro ao carregar dados.</div>";
        });

      modal.show();
    });
  });

  // Limpa corretamente ao fechar (evita overlay preso)
  modalEl.addEventListener("hidden.bs.modal", function () {
    document.querySelectorAll(".modal-backdrop").forEach(el => el.remove());
    document.body.classList.remove("modal-open");
    document.body.style.removeProperty("padding-right");
    document.body.style.removeProperty("overflow");
  });
});
</script>

</body>
</html>
